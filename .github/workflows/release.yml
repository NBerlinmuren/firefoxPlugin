name: Release Firefox Extension

on:
  push:
    branches: [master]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install web-ext
        run: npm install -g web-ext

      - name: Read version from manifest
        id: meta
        run: |
          VERSION=$(jq -r '.version' manifest.json)
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "short_sha=$SHORT_SHA" >> "$GITHUB_OUTPUT"

      - name: Sign extension with Mozilla
        run: |
          web-ext sign \
            --source-dir . \
            --artifacts-dir ./artifacts \
            --api-key "$AMO_API_KEY" \
            --api-secret "$AMO_API_SECRET" \
            --channel unlisted
        env:
          AMO_API_KEY: ${{ secrets.AMO_API_KEY }}
          AMO_API_SECRET: ${{ secrets.AMO_API_SECRET }}

      - name: Find signed .xpi
        id: xpi
        run: |
          XPI_PATH=$(ls ./artifacts/*.xpi)
          echo "path=$XPI_PATH" >> "$GITHUB_OUTPUT"
          echo "filename=$(basename "$XPI_PATH")" >> "$GITHUB_OUTPUT"

      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.meta.outputs.version }}
          name: YouTube & Reddit Limiter v${{ steps.meta.outputs.version }}
          body: |
            ## Install in Firefox

            1. Download the `.xpi` file below
            2. Open Firefox and go to `about:addons`
            3. Click the gear icon → **Install Add-on From File…**
            4. Select the downloaded `.xpi` file

            Or drag and drop the `.xpi` file into a Firefox window.

            ---
            Built from commit `${{ steps.meta.outputs.short_sha }}`
          files: ${{ steps.xpi.outputs.path }}
          make_latest: true
